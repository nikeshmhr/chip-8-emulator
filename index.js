/*! For license information please see index.js.LICENSE.txt */
(()=>{"use strict";var t={407:(t,e,s)=>{s.r(e),s.d(e,{default:()=>i});var r=function(){this.list=Object.create(null)};r.prototype.has=function(t){return~Object.keys(this.list).indexOf(t)},r.prototype.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)},r.prototype.emit=function(t){for(var e=[],s=arguments.length-1;s-- >0;)e[s]=arguments[s+1];if(this.list[t]){for(var r=0;r<this.list[t].length;r++){var i=this.list[t][r];i.callback.apply(i,e),i.once&&this.list[t].splice(r--,1)}this.list[t]&&0===this.list[t].length&&delete this.list[t]}},r.prototype.on=function(t,e){this.has(t)||(this.list[t]=[]),this.list[t].push({callback:e})},r.prototype.once=function(t,e){this.has(t)||(this.list[t]=[]),this.list[t].push({once:!0,callback:e})},r.prototype.off=function(t,e){var s=this;if(this.isArray(t))t.forEach((function(t){return delete s.list[t]}));else if("string"==typeof t&&"function"==typeof e){if(this.has(t)){var r=this.list[t].findIndex((function(t){return t.callback===e}));~r&&this.list[t].splice(r,1)}}else this.list=Object.create(null)};const i=r},956:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.default=class{constructor(){this.keyState=new Array(16).fill(!1),this.keyMap={0:0,1:1,3:2,4:3,q:4,w:5,e:6,r:7,a:8,s:9,d:10,f:11,z:12,x:13,c:14,v:15},window.addEventListener("keydown",this.onKeyDown.bind(this)),window.addEventListener("keyup",this.onKeyUp.bind(this))}onKeyDown(t){const e=t.key.toLowerCase();this.keyMap.hasOwnProperty(e)&&(this.keyState[this.keyMap[e]]=!0)}onKeyUp(t){const e=t.key.toLowerCase();this.keyMap.hasOwnProperty(e)&&(this.keyState[this.keyMap[e]]=!1)}get key(){return this.keyState}}},921:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PIXEL_COLOR=e.SPRITE_WIDTH=e.SCALE_FACTOR=e.SCREEN_HEIGHT=e.SCREEN_WIDTH=e.INSTRUCTION_BYTES=e.MEMORY_SIZE=e.PROGRAM_START_ADDRESS=e.FONT_SET=e.FONT_START_ADDRESS=e.FRAME_TIME_MS=e.MILLISECONDS_IN_A_SECOND=e.FPS=void 0,e.FPS=60,e.MILLISECONDS_IN_A_SECOND=1e3,e.FRAME_TIME_MS=e.MILLISECONDS_IN_A_SECOND/e.FPS,e.FONT_START_ADDRESS=80,e.FONT_SET=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128],e.PROGRAM_START_ADDRESS=512,e.MEMORY_SIZE=4096,e.INSTRUCTION_BYTES=2,e.SCREEN_WIDTH=64,e.SCREEN_HEIGHT=32,e.SCALE_FACTOR=10,e.SPRITE_WIDTH=8,e.PIXEL_COLOR="#b4e5af"},914:function(t,e,s){var r,i=this&&this.__createBinding||(Object.create?function(t,e,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(e,s);i&&!("get"in i?!e.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,r,i)}:function(t,e,s,r){void 0===r&&(r=s),t[r]=e[s]}),n=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),o=this&&this.__importStar||(r=function(t){return r=Object.getOwnPropertyNames||function(t){var e=[];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[e.length]=s);return e},r(t)},function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var s=r(t),o=0;o<s.length;o++)"default"!==s[o]&&i(e,t,s[o]);return n(e,t),e}),a=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const l=s(921),c=o(s(957)),u=a(s(614));e.default=class{constructor(t,e,s,r,i){this.memory=t,this.displayBuffer=e,this.displayRenderer=s,this.soundInterface=r,this.keyInput=i,this.V=new Uint8Array(16),this.PC=l.PROGRAM_START_ADDRESS,this.I=0,this.logger=u.default.getInstance("Cpu"),this.delayTimer=0,this.soundTimer=0,this.loadFontSet(),this.startTimers()}getState(){return{registers:this.V,PC:this.PC,I:this.I,delayTimer:this.delayTimer,soundTimer:this.soundTimer}}loadFontSet(){this.logger.log("Loading font set...");for(let t=0;t<l.FONT_SET.length;t++){const e=t+l.FONT_START_ADDRESS;this.memory.setMemory(e,l.FONT_SET[t])}this.logger.log("Font set loaded")}startTimers(){setInterval((()=>{this.delayTimer>0&&this.delayTimer--,this.soundTimer>0&&(console.log("BEEP"),this.soundInterface.beep(),this.soundTimer--)}),1e3/60)}setPC(t){const e=this.PC;this.PC=t,e!==this.PC&&c.default.getInstance().publish(c.EVENTS.PROGRAM_COUNTER_UPDATED,this.PC)}setRegisterValue(t,e){const s=this.V[t];this.V[t]=e,s!==e&&(this.V[t]=e,c.default.getInstance().publish(c.EVENTS.REGISTER_UPDATED,{register:t,value:e}))}fetchInstruction(){const t=this.memory.memory[this.PC]<<8|this.memory.memory[this.PC+1];return this.setPC(this.PC+2),t}decodeInstruction(t){return{x:(3840&t)>>8,y:(240&t)>>4,n:15&t,nn:255&t,nnn:4095&t,instructionSet:61440&t}}executeInstruction(t,e){const{x:s,y:r,n:i,nn:n,nnn:o,instructionSet:a}=e;switch(a){case 0:switch(n){case 224:this.displayBuffer.clear(),this.displayRenderer.drawScreen(this.displayBuffer.pixelData);break;case 238:const e=this.memory.popStack();this.setPC(e);break;default:throw new Error(`Unknown opcode: ${t.toString(16).padStart(4,"0")}`)}break;case 4096:this.setPC(o);break;case 24576:this.setRegisterValue(s,n);break;case 28672:this.setRegisterValue(s,this.V[s]+n);break;case 40960:this.I=o;break;case 53248:{const t=i,e=this.V[s],n=this.V[r];this.setRegisterValue(15,0);const o=new Uint8Array(t);for(let e=0;e<t;e++)o[e]=this.memory.memory[this.I+e];const a=this.displayBuffer.write(e,n,o);this.setRegisterValue(15,a?1:0),this.displayRenderer.drawScreen(this.displayBuffer.pixelData);break}case 12288:this.V[s]===n&&this.setPC(this.PC+2);break;case 20480:this.V[s]===this.V[r]&&this.setPC(this.PC+2);break;case 16384:this.V[s]!==n&&this.setPC(this.PC+2);break;case 32768:switch(i){case 0:this.setRegisterValue(s,this.V[r]);break;case 1:this.setRegisterValue(s,this.V[s]|this.V[r]);break;case 2:this.setRegisterValue(s,this.V[s]&this.V[r]);break;case 3:this.setRegisterValue(s,this.V[s]^this.V[r]);break;case 4:this.setRegisterValue(15,this.V[s]+this.V[r]>255?1:0),this.setRegisterValue(s,this.V[s]+this.V[r]);break;case 5:this.setRegisterValue(15,this.V[s]>this.V[r]?1:0),this.setRegisterValue(s,this.V[s]-this.V[r]);break;case 7:this.setRegisterValue(15,this.V[s]>this.V[r]?1:0),this.setRegisterValue(s,this.V[r]-this.V[s]);break;case 6:this.setRegisterValue(s,this.V[r]),this.setRegisterValue(15,this.V[s]>>7),this.setRegisterValue(s,this.V[s]>>1);break;case 14:this.setRegisterValue(s,this.V[r]),this.setRegisterValue(15,this.V[s]>>7),this.setRegisterValue(s,this.V[s]<<1);break;default:throw new Error(`Unknown opcode: ${t.toString(16)}`)}break;case 61440:switch(n){case 41:const e=this.V[s],r=l.FONT_START_ADDRESS+5*e;this.I=this.memory.memory[r];break;case 85:for(let t=0;t<=s;t++)this.memory.setMemory(this.I+t,this.V[t]);this.I=this.I+s+1;break;case 101:for(let t=0;t<=s;t++)this.setRegisterValue(t,this.memory.memory[this.I+t]);this.I=this.I+s+1;break;case 51:{const t=this.V[s];this.memory.setMemory(this.I,Math.floor(t/100)),this.memory.setMemory(this.I+1,Math.floor(t%100/10)),this.memory.setMemory(this.I+2,t%10);break}case 30:this.I+=this.V[s];break;case 21:this.delayTimer=this.V[s];break;case 7:this.setRegisterValue(s,this.delayTimer);break;case 24:console.log("timer set"),this.soundTimer=this.V[s];break;case 10:let i=!1;for(let t=0;t<this.keyInput.key.length;t++)if(!0===this.keyInput.key[t]){this.setRegisterValue(s,t),i=!0;break}i||this.setPC(this.PC-2);break;default:throw new Error(`Unknown opcode: ${t.toString(16)}`)}break;case 36864:this.V[s]!==this.V[r]&&this.setPC(this.PC+2);break;case 8192:this.memory.pushStack(this.PC),this.setPC(o);break;case 45056:this.setPC(o+this.V[0]);break;case 49152:this.setRegisterValue(s,Math.floor(255*Math.random())&n);break;case 57344:switch(n){case 161:!1===this.keyInput.key[this.V[s]]&&this.setPC(this.PC+2);break;case 158:!0===this.keyInput.key[this.V[s]]&&this.setPC(this.PC+2);break;default:throw new Error(`Unknown opcode: ${t.toString(16)}`)}break;default:const e=`Unknown opcode: ${t.toString(16)}`;throw this.logger.error(e),new Error(e)}}executeCycle(){const t=this.fetchInstruction(),e=this.decodeInstruction(t);this.executeInstruction(t,e)}}},516:function(t,e,s){var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const i=s(921),n=r(s(614));e.default=class{constructor(){this.pixelState=[[]],this.logger=n.default.getInstance("DisplayBuffer"),this.pixelState=new Array(i.SCREEN_HEIGHT).fill(0).map((()=>new Array(i.SCREEN_WIDTH).fill(0)))}clear(){for(let t=0;t<i.SCREEN_HEIGHT;t++)for(let e=0;e<i.SCREEN_WIDTH;e++)this.pixelState[t][e]=0}write(t,e,s){let r=!1;try{for(let n=0;n<s.length;n++){const o=s[n];for(let s=0;s<i.SPRITE_WIDTH;s++){const a=o>>7-s&1,l=(t+s)%i.SCREEN_WIDTH,c=(e+n)%i.SCREEN_HEIGHT;1===this.pixelState[c][l]&&1===a&&(r=!0),this.pixelState[c][l]^=a}}}catch(t){this.logger.error(t)}return r}get pixelData(){return this.pixelState}}},665:(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0});const r=s(921);e.default=class{constructor(t){this.context=t}fillRect(t,e,s,i){this.context.fillStyle=r.PIXEL_COLOR,this.context.fillRect(t,e,s,i)}clearRect(t,e,s,r){this.context.clearRect(t,e,s,r)}drawScreen(t){const e=t[0].length*r.SCALE_FACTOR,s=t.length*r.SCALE_FACTOR;this.clearRect(0,0,e,s);for(let e=0;e<t.length;e++)for(let s=0;s<t[e].length;s++)1===t[e][s]&&this.fillRect(s*r.SCALE_FACTOR,e*r.SCALE_FACTOR,r.SCALE_FACTOR,r.SCALE_FACTOR)}}},597:function(t,e,s){var r,i=this&&this.__createBinding||(Object.create?function(t,e,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(e,s);i&&!("get"in i?!e.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,r,i)}:function(t,e,s,r){void 0===r&&(r=s),t[r]=e[s]}),n=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),o=this&&this.__importStar||(r=function(t){return r=Object.getOwnPropertyNames||function(t){var e=[];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[e.length]=s);return e},r(t)},function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var s=r(t),o=0;o<s.length;o++)"default"!==s[o]&&i(e,t,s[o]);return n(e,t),e}),a=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const l=s(921),c=a(s(914)),u=a(s(516)),h=a(s(97)),d=a(s(665)),f=a(s(614)),m=a(s(46)),g=a(s(956)),y=o(s(957));e.default=class{constructor(t){this.lastCycleTime=0,this.logger=f.default.getInstance("Emulator"),this.logger.log("Emulator created"),this.memory=new h.default,this.displayBuffer=new u.default;const e=document.getElementById("screen");this.displayRenderer=new d.default(e.getContext("2d")),this.cpu=new c.default(this.memory,this.displayBuffer,this.displayRenderer,new m.default,new g.default),this.initProgram(t)}run(){const t=Date.now();t-this.lastCycleTime>=l.FRAME_TIME_MS&&(this.lastCycleTime=t,this.cpu.executeCycle())}getEmulatorState(){return{memory:this.memory.getState(),cpu:this.cpu.getState()}}initProgram(t){this.loadProgram(t),y.default.getInstance().publish(y.EVENTS.PROGRAM_LOADED,null)}loadProgram(t){this.logger.log("Loading program...");for(let e=0;e<t.length;e++){const s=e+l.PROGRAM_START_ADDRESS;this.memory.setMemory(s,t[e])}}}},957:function(t,e,s){var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.EVENTS=void 0;const i=r(s(407)),n=r(s(614));e.EVENTS={REGISTER_UPDATED:"REGISTER_UPDATED",PROGRAM_COUNTER_UPDATED:"PROGRAM_COUNTER_UPDATED",PROGRAM_LOADED:"PROGRAM_LOADED"};class o{constructor(){this.emitter=new i.default,this.logger=n.default.getInstance("EventsManager")}subscribe(t,e){this.emitter.on(t,e)}publish(t,e){this.emitter.emit(t,e)}static getInstance(){return o.instance||(o.instance=new o),o.instance}}e.default=o},156:function(t,e,s){var r=this&&this.__awaiter||function(t,e,s,r){return new(s||(s=Promise))((function(i,n){function o(t){try{l(r.next(t))}catch(t){n(t)}}function a(t){try{l(r.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,a)}l((r=r.apply(t,e||[])).next())}))},i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const n=i(s(597)),o=i(s(427));window.addEventListener("DOMContentLoaded",(()=>r(void 0,void 0,void 0,(function*(){let t="IBM_LOGO";const e=new URLSearchParams(window.location.search).get("rom")||"";e&&(t=e);const s=yield fetch(`/rom/${t}`).then((t=>t.arrayBuffer())),r=new n.default(new Uint8Array(s));new o.default(r,t).printMemory(),function t(){r.run(),requestAnimationFrame(t)}()}))))},614:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0});class s{constructor(t){this.name=t}log(t){console.log(`${this.name}:`,t)}error(t){console.error(`${this.name}:`,t)}static getInstance(t){return new s(t)}}e.default=s},97:function(t,e,s){var r,i=this&&this.__createBinding||(Object.create?function(t,e,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(e,s);i&&!("get"in i?!e.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,r,i)}:function(t,e,s,r){void 0===r&&(r=s),t[r]=e[s]}),n=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),o=this&&this.__importStar||(r=function(t){return r=Object.getOwnPropertyNames||function(t){var e=[];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[e.length]=s);return e},r(t)},function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var s=r(t),o=0;o<s.length;o++)"default"!==s[o]&&i(e,t,s[o]);return n(e,t),e});Object.defineProperty(e,"__esModule",{value:!0});const a=s(921),l=o(s(957));e.default=class{constructor(){this._memory=new Uint8Array(a.MEMORY_SIZE),this._stack=[]}getState(){return{memory:this._memory,stack:this._stack}}get memory(){return this._memory}setMemory(t,e){if(t<0||t>this._memory.length)throw new Error("Memory address out of bounds");this._memory[t]=e,l.default.getInstance().publish(l.EVENTS.REGISTER_UPDATED,this.memory)}pushStack(t){this._stack.push(t)}popStack(){if(0===this._stack.length)throw new Error("Stack is empty");return this._stack.pop()}}},46:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.default=class{constructor(){this.audioContext=new AudioContext}beep(){const t=this.audioContext.createGain();t.connect(this.audioContext.destination),t.gain.value=.5;const e=this.audioContext.createOscillator();e.connect(t),e.type="square",e.frequency.value=87.30705785825097,e.start(),e.stop(this.audioContext.currentTime+.1)}}},427:function(t,e,s){var r,i=this&&this.__createBinding||(Object.create?function(t,e,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(e,s);i&&!("get"in i?!e.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,r,i)}:function(t,e,s,r){void 0===r&&(r=s),t[r]=e[s]}),n=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),o=this&&this.__importStar||(r=function(t){return r=Object.getOwnPropertyNames||function(t){var e=[];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[e.length]=s);return e},r(t)},function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var s=r(t),o=0;o<s.length;o++)"default"!==s[o]&&i(e,t,s[o]);return n(e,t),e});Object.defineProperty(e,"__esModule",{value:!0});const a=o(s(957));e.default=class{constructor(t,e){console.log("UI class initialized"),this.emulator=t,this.init(),this.setProgramOptions(e),this.loadProgramHandler()}get memoryUIElement(){return document.getElementById("memory")}get registerUIElement(){return document.getElementById("registers")}get selectProgramElement(){return document.getElementById("select-program")}get loadProgramButtonElement(){return document.getElementById("load-program")}get toggleDebuggerButtonElement(){return document.getElementById("toggle-debugger")}get stepButtonElement(){return document.getElementById("step")}get continueProgramButtonElement(){return document.getElementById("continue")}handleRegisterUpdate(){let t='\n      <div class="row">\n          <div>Register values</div>\n      </div>\n      <div class="row">\n          <div>Name</div>\n          <div>Values</div>\n      </div>\n    ';const e=this.emulator.getEmulatorState().cpu.registers;for(let s=0;s<e.length;s++){const r=e[s].toString(16).padStart(8,"0");t+=`\n        <div class="row">\n            <div title="${e[s]}">V${s}</div>\n            <div title="${e[s]}">0x${r}</div>\n        </div>\n      `}this.registerUIElement.innerHTML=t}printMemory(){let t='\n      <div class="memory-heading">Memory</div>\n    ';const e=this.emulator.getEmulatorState().memory.memory,s=this.emulator.getEmulatorState().cpu.PC;for(let r=0;r<e.length;r+=2){const i=(r+0).toString(16).padStart(4,"0");t+=`\n        <div id="p${i}" class="${s===r+0?"current-pc":""}">\n          <span class="address">${i}</span>\n          <span class="opcode">0x${(e[r+0]<<8|e[r+0+1]).toString(16).padStart(4,"0")}</span>\n        </div>\n      `}this.memoryUIElement.innerHTML=t}handlePCUpdate(){const t=this.emulator.getEmulatorState().cpu.PC.toString(16).padStart(4,"0"),e=document.getElementById(`p${t}`);if(e){const t=document.querySelector(".current-pc");t&&t.classList.remove("current-pc"),e.classList.add("current-pc"),e.scrollIntoView({behavior:"instant",block:"center",inline:"center"})}}setProgramOptions(t){const e=this.selectProgramElement,s=["BLINKY","CAVE","IBM_LOGO","INVADERS","MAZE","OUTLAW","PONG","TANK","TETRIS"];for(const t of s){const s=document.createElement("option");s.value=t,s.text=t,e.add(s)}e.value=t}loadProgramHandler(){this.loadProgramButtonElement.addEventListener("click",(()=>{const t=this.selectProgramElement.value;window.location.href=`?rom=${t}`}))}init(){const t=a.default.getInstance(),e={[a.EVENTS.REGISTER_UPDATED]:this.handleRegisterUpdate.bind(this),[a.EVENTS.PROGRAM_COUNTER_UPDATED]:this.handlePCUpdate.bind(this),[a.EVENTS.PROGRAM_LOADED]:this.printMemory.bind(this)};for(const s in e)t.subscribe(s,e[s])}}}},e={};function s(r){var i=e[r];if(void 0!==i)return i.exports;var n=e[r]={exports:{}};return t[r].call(n.exports,n,n.exports,s),n.exports}s.d=(t,e)=>{for(var r in e)s.o(e,r)&&!s.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s(156)})();